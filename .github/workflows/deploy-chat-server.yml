name: chat-serverë§Œ Amazon ECS ë°°í¬

on:
  push:
    branches: [ "main" ]
    paths:
      - 'chat-server/**'
      - '.github/workflows/deploy-chat-server.yml'

permissions:
  contents: read

env:
  AWS_REGION: ap-northeast-2
  CONTAINER_NAME: chat-container
  ECR_REPOSITORY: dulakreposiotry
  ECS_CLUSTER: happy-lion-zahji5
  ECS_SERVICE: chat-server-ec2
  ECS_TASK_DEFINITION: chat-server/chat-server-ec2-revision1.json
  IMAGE_TAG: chat-latest

jobs:
  deploy:
    name: Amazon ECSì— ë°°í¬
    runs-on: ubuntu-latest

    steps:
      # ğŸš€ ë°°í¬ ì‹œì‘
      - name: ë””ìŠ¤ì½”ë“œ ì•Œë¦¼ - ë°°í¬ ì‹œì‘
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          TZ: Asia/Seoul
        run: |
          set -e
          NOW=$(date '+%Y-%m-%d %H:%M:%S')
          payload=$(printf '{"content":"```\\n[ë°°í¬ ì‹œì‘]\\nChat-Server\\n[ì¼ì‹œ]\\n%s\\n\\n[ë°°í¬ ê²°ê³¼]\\nì§„í–‰ ì¤‘\\n\\n[ì•ˆë‚´]\\nì•½ 10ë¶„ ì •ë„ ì„œë²„ê°€ ë‹¤ìš´ë©ë‹ˆë‹¤.\\n```"}' "$NOW")
          curl -sS -X POST \
            -H "Content-Type: application/json" \
            --data-binary "$payload" \
            "$DISCORD_WEBHOOK_URL"
      - name: ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: JDK 21 ì„¤ì •
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: application.yml ìƒì„±
        run: |
          mkdir -p ./chat-server/src/main/resources
          echo "${{ secrets.APPLICATION_YML_CHAT }}" > ./chat-server/src/main/resources/application.yml
      - name: Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x ./gradlew

      - name: Gradle ë¹Œë“œ (chat-serverë§Œ)
        run: ./gradlew :chat-server:clean :chat-server:build -x test

      - name: AWS ìê²© ì¦ëª… êµ¬ì„±
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Amazon ECR ë¡œê·¸ì¸
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        run: |
          cd chat-server
          docker build -t ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} .
          docker push ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
      - name: ECS íƒœìŠ¤í¬ ì •ì˜ ë Œë”ë§
        id: render-task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: ${{ env.ECS_TASK_DEFINITION }}
          container-name: ${{ env.CONTAINER_NAME }}
          image: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}

      - name: ECS ì„œë¹„ìŠ¤ì— ë°°í¬
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.render-task-def.outputs.task-definition }}
          service: ${{ env.ECS_SERVICE }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true

      # ğŸŸ¢ ë°°í¬ ì„±ê³µ
      - name: ë””ìŠ¤ì½”ë“œ ì•Œë¦¼ - ë°°í¬ ì„±ê³µ
        if: success()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          TZ: Asia/Seoul
        run: |
          set -e
          NOW=$(date '+%Y-%m-%d %H:%M:%S')
          payload=$(printf '{"content":"```\\n[ë°°í¬ ì™„ë£Œ]\\n\\n[ì¼ì‹œ]\\n%s\\n\\n[ë°°í¬ ê²°ê³¼]\\nì„±ê³µ\\n\\n[ì•ˆë‚´]\\nì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.\\n```"}' "$NOW")
          curl -sS -X POST \
            -H "Content-Type: application/json" \
            --data-binary "$payload" \
            "$DISCORD_WEBHOOK_URL"
      # ğŸ”´ ë°°í¬ ì‹¤íŒ¨
      - name: ë””ìŠ¤ì½”ë“œ ì•Œë¦¼ - ë°°í¬ ì‹¤íŒ¨
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          TZ: Asia/Seoul
        run: |
          set -e
          NOW=$(date '+%Y-%m-%d %H:%M:%S')
          payload=$(printf '{"content":"```\\n[ë°°í¬ ì‹¤íŒ¨]\\n\\n[ì¼ì‹œ]\\n%s\\n\\n[ë°°í¬ ê²°ê³¼]\\nì‹¤íŒ¨\\n\\n[ì•ˆë‚´]\\nì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.\\n```"}' "$NOW")
          curl -sS -X POST \
            -H "Content-Type: application/json" \
            --data-binary "$payload" \
            "$DISCORD_WEBHOOK_URL"